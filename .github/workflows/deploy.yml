name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted
    env:
      FULL_DEPLOY: ${{ secrets.FULL_DEPLOY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # 获取最近两次提交以便比较变更

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Angular CLI
        run: npm install -g @angular/cli

      - name: Install dependencies
        run: npm install

      - name: Run process script
        run: node process.js

      - name: Get changed files
        id: changed-files
        if: env.FULL_DEPLOY != 'true'
        run: |
          # 获取变更的文件列表（只包含docs目录下的文件）
          CHANGED_FILES=$(git diff --name-only HEAD HEAD~1 | grep '^docs/' || true)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          # 将变更文件列表保存到环境变量
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          # 检查是否有变更文件
          if [ -z "$CHANGED_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Incremental Deploy- Changed files only
        if: env.FULL_DEPLOY != 'true' && steps.changed-files.outputs.has_changes == 'true'
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          local_path: './docs/'
          remote_path: ${{ secrets.TARGET_DIR }}
          sftp_only: true
          args: '-o ConnectTimeout=5'

      - name: Full Deploy (All files)
        if: env.FULL_DEPLOY == 'true'
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          local_path: './docs/'
          remote_path: ${{ secrets.TARGET_DIR }}
          sftp_only: true
          delete_remote_files: true  # 全量部署时删除远程旧文件
          args: '-o ConnectTimeout=5'

      - name: Deployment Summary
        run: |
          if [ "${{ secrets.FULL_DEPLOY }}" == "true" ]; then
            echo "✅ 完成全量部署"
          elif [ "${{ steps.changed-files.outputs.has_changes }}" == "true" ]; then
            echo "✅ 完成增量部署，上传了变更的文件"
          else
            echo "ℹ️ 没有检测到docs目录的变更，跳过部署"
          fi


